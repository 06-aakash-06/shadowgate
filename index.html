<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOWGATE // ULTIMATE_V9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { term: { black: '#050505', green: '#00ff41', dim: '#003300', alert: '#ff003c' } }, fontFamily: { mono: ['"Share Tech Mono"', 'monospace'] } } } }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #050505; color: #00ff41; font-family: 'Share Tech Mono', monospace; overflow-x: hidden; }
        .crt-line { width: 100%; height: 2px; background: rgba(0, 255, 65, 0.1); position: absolute; animation: scan 3s linear infinite; pointer-events: none; z-index: 50; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        .input-box { background: #0a0a0a; border: 1px solid #003300; padding: 12px; width: 100%; color: #00ff41; outline: none; margin-bottom: 8px; font-size: 16px; } 
        .input-box:focus { border-color: #00ff41; box-shadow: 0 0 8px rgba(0, 255, 65, 0.2); }
        .cyber-btn { background: #003300; border: 1px solid #00ff41; color: #00ff41; padding: 15px; width: 100%; text-transform: uppercase; font-weight: bold; letter-spacing: 2px; transition: 0.2s; }
        .cyber-btn:active { background: #00ff41; color: #000; }
        .cyber-btn:disabled { border-color: #333; color: #555; background: #000; }
        .tab-btn { flex: 1; py-2; text-xs; font-bold; border: 1px solid; text-align: center; cursor: pointer; }
    </style>
</head>

<body x-data="shadowFlix()" x-cloak class="min-h-screen flex flex-col relative">

    <div class="crt-line"></div>

    <template x-if="!session">
        <div class="flex-grow flex flex-col items-center justify-center p-6 text-center">
            <h1 class="text-5xl mb-2 text-white">SHADOWGATE</h1>
            <p class="text-xs text-term-dim mb-12">DIRECT_DB_INJECTION_TOOLKIT</p>

            <div class="w-full max-w-sm border border-term-dim p-6 bg-black/80 relative">
                <div class="absolute top-2 right-2 w-2 h-2 rounded-full" :class="loading ? 'bg-yellow-500 animate-pulse' : 'bg-term-dim'"></div>
                <p class="text-xs text-term-dim mb-4 text-left">>> AUTHENTICATION_REQUIRED</p>
                <button @click="openLogin" class="cyber-btn mb-4">INITIATE_MICROSOFT_LINK</button>
                <div class="h-20 bg-black border border-term-dim p-2 text-left overflow-y-auto">
                    <template x-for="log in logs">
                        <p class="text-[10px] text-gray-500"><span class="text-term-green">></span> <span x-text="log"></span></p>
                    </template>
                </div>
            </div>
            
            <div class="mt-8 text-[10px] text-gray-600 max-w-xs">
                <p class="text-term-alert">IOS USERS: Turn OFF "Prevent Cross-Site Tracking" in Settings > Safari</p>
            </div>
        </div>
    </template>

    <template x-if="session">
        <div class="p-4 w-full max-w-3xl mx-auto">
            <div class="flex justify-between items-end border-b border-term-dim pb-4 mb-6">
                <div>
                    <h2 class="text-2xl text-white">ACCESS_GRANTED</h2>
                    <p class="text-[10px] text-term-green">UID: <span x-text="session.$id"></span></p>
                </div>
                <button @click="logout" class="text-xs text-term-alert border border-term-alert px-2 py-1">UNLINK</button>
            </div>

            <div class="flex gap-2 mb-6">
                <div @click="tab='inject'" :class="tab==='inject' ? 'bg-term-green text-black' : 'text-term-dim border-term-dim'" class="tab-btn border">INJECT</div>
                <div @click="loadHistory" :class="tab==='history' ? 'bg-term-green text-black' : 'text-term-dim border-term-dim'" class="tab-btn border">HISTORY</div>
                <div @click="tab='verify'" :class="tab==='verify' ? 'bg-term-green text-black' : 'text-term-dim border-term-dim'" class="tab-btn border">DECODE</div>
            </div>

            <div x-show="tab==='inject'" class="animate-fade-in">
                <div class="border border-term-dim p-4 bg-black/50">
                    <p class="text-xs text-term-dim mb-4">>> PAYLOAD_CONFIG</p>
                    
                    <select x-model="form.type" class="input-box bg-black">
                        <option value="weekendPass">WEEKEND PASS</option>
                        <option value="eveningOutPass">EVENING OUT</option>
                        <option value="workingDayPass">WORKING DAY</option>
                        <option value="holidayPass">HOLIDAY</option>
                    </select>

                    <input x-model="form.place" type="text" placeholder="DESTINATION" class="input-box">
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-gray-500 block mb-1">DEPART DATE</label>
                            <input x-model="form.outDate" type="date" class="input-box">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 block mb-1">DEPART TIME</label>
                            <input x-model="form.outTime" type="time" class="input-box">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-gray-500 block mb-1">RETURN DATE</label>
                            <input x-model="form.inDate" type="date" class="input-box">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 block mb-1">RETURN TIME</label>
                            <input x-model="form.inTime" type="time" class="input-box">
                        </div>
                    </div>

                    <textarea x-model="form.purpose" rows="2" placeholder="PURPOSE" class="input-box"></textarea>

                    <button @click="injectPass" :disabled="loading" class="cyber-btn mt-4">
                        <span x-show="!loading">EXECUTE_WRITE</span>
                        <span x-show="loading">INJECTING...</span>
                    </button>
                </div>
            </div>

            <div x-show="tab==='history'" class="animate-fade-in">
                <div x-show="activePasses.length > 0" class="mb-6">
                    <p class="text-xs text-white mb-2 border-b border-white pb-1">>> ACTIVE_SIGNALS</p>
                    <div class="space-y-3">
                        <template x-for="p in activePasses" :key="p.$id">
                            <div class="border border-term-green bg-term-dim/20 p-3 relative overflow-hidden">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-bold text-white" x-text="p.place"></h3>
                                        <p class="text-[10px] text-term-green" x-text="new Date(p.startDate).toLocaleString()"></p>
                                    </div>
                                    <button @click="regenerateQR(p)" class="text-[10px] border border-term-green px-2 py-1 hover:bg-term-green hover:text-black">SHOW QR</button>
                                </div>
                                <p class="text-[9px] text-gray-400 mt-1 uppercase" x-text="p.requestType"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="expiredPasses.length > 0">
                    <p class="text-xs text-term-dim mb-2 border-b border-term-dim pb-1">>> EXPIRED_LOGS</p>
                    <div class="space-y-2 opacity-60">
                        <template x-for="p in expiredPasses" :key="p.$id">
                            <div class="border border-term-dim p-2 flex justify-between items-center bg-black">
                                <div>
                                    <p class="text-sm text-gray-300" x-text="p.place"></p>
                                    <p class="text-[9px] text-gray-500" x-text="new Date(p.startDate).toLocaleDateString()"></p>
                                </div>
                                <span class="text-[9px] text-term-alert">EXPIRED</span>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="activePasses.length === 0 && expiredPasses.length === 0" class="text-center py-8 text-term-dim">
                    NO_RECORDS_FOUND
                </div>
            </div>

            <div x-show="tab==='verify'" class="animate-fade-in">
                <div x-show="ticket" class="border border-term-green border-dashed p-6 flex flex-col items-center justify-center mb-6 bg-black">
                    <div id="qrcode" class="bg-white p-2 mb-4"></div>
                    <h3 class="text-xl font-bold text-white" x-text="ticket?.place"></h3>
                    <p class="text-xs text-term-green mt-1">STATUS: APPROVED</p>
                    
                    <div class="flex gap-4 mt-6">
                        <button @click="downloadQR" class="text-xs border border-white px-3 py-2 hover:bg-white hover:text-black transition">
                            DOWNLOAD_IMG
                        </button>
                        <button @click="ticket=null" class="text-xs text-gray-500 underline py-2">
                            CLOSE
                        </button>
                    </div>
                </div>

                <div x-show="!ticket">
                    <div id="reader" class="w-full h-64 bg-black border border-term-dim mb-4 overflow-hidden relative">
                        <div class="absolute inset-0 flex items-center justify-center text-xs text-term-dim">CAMERA_OFFLINE</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="startScanner" class="input-box text-center text-xs font-bold hover:bg-term-dim">ACTIVATE_CAM</button>
                        <label class="input-box text-center text-xs font-bold hover:bg-term-dim pt-3">
                            UPLOAD_IMG
                            <input type="file" accept="image/*" class="hidden" @change="handleFileUpload">
                        </label>
                    </div>
                    <div x-show="scanResult" class="mt-4 p-3 bg-gray-900 border-l-2 border-term-green">
                        <pre class="text-[10px] whitespace-pre-wrap" x-text="scanResult"></pre>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const { Client, Account, Databases, ID, Query } = Appwrite;

        function shadowFlix() {
            return {
                client: new Client(), account: null, databases: null,
                endpoint: 'https://hostelgatepass.ssn.edu.in/v1', 
                project: 'ssn-gatepass-1', dbId: 'ssndb', collId: 'gatepassRequests',
                session: null, loading: false, logs: ['SYSTEM_READY'], tab: 'inject', 
                ticket: null, scanResult: null,
                activePasses: [], expiredPasses: [],
                
                form: { 
                    type: 'weekendPass', 
                    place: '', 
                    outDate: new Date().toISOString().split('T')[0], 
                    outTime: '16:00', 
                    inDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], 
                    inTime: '08:00',
                    purpose: '' 
                },

                init() {
                    this.client.setEndpoint(this.endpoint).setProject(this.project);
                    this.account = new Account(this.client); 
                    this.databases = new Databases(this.client);

                    if (window.opener) {
                        localStorage.setItem('shadow_sync', Date.now());
                        window.close(); return;
                    }
                    this.checkSession();
                    window.addEventListener('storage', (e) => {
                        if (e.key === 'shadow_sync') this.checkSession();
                    });
                },

                openLogin() {
                    const callback = window.location.href; 
                    const url = `${this.endpoint}/account/sessions/oauth2/microsoft?project=${this.project}&success=${encodeURIComponent(callback)}&failure=${encodeURIComponent(callback)}`;
                    window.open(url, 'shadow_auth', 'width=800,height=600');
                    const poller = setInterval(() => { this.checkSession(); if(this.session) clearInterval(poller); }, 2000);
                },

                async checkSession() {
                    try {
                        this.session = await this.account.get();
                        this.log('SESSION_ACTIVE');
                    } catch { this.session = null; }
                },

                async logout() { await this.account.deleteSession('current'); location.reload(); },
                log(msg) { this.logs.unshift(msg); },

                async injectPass() {
                    if (!this.form.place || !this.form.purpose) return alert("MISSING_DATA");
                    this.loading = true;
                    try {
                        // 1. Create Date Objects
                        const startObj = new Date(`${this.form.outDate}T${this.form.outTime}:00`);
                        const endObj = new Date(`${this.form.inDate}T${this.form.inTime}:00`);

                        if (endObj <= startObj) throw new Error("End Date must be after Start Date");

                        const diffMs = Math.abs(endObj - startObj);
                        const days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

                        // 2. Set Approval Defaults
                        let mentorStatus = 'exempted';
                        let supervisorStatus = 'exempted';
                        let wardenStatus = 'approved';

                        // 3. Apply Special Rules for Weekend & Evening Out
                        if (this.form.type === 'weekendPass' || this.form.type === 'eveningOutPass') {
                            supervisorStatus = 'approved'; // Force Supervisor Approval
                            mentorStatus = 'exempted';     // Mentor is exempted
                            wardenStatus = 'approved';     // Warden is approved
                        }

                        // 4. Construct Payload
                        const doc = await this.databases.createDocument(this.dbId, this.collId, ID.unique(), {
                            requestType: this.form.type, 
                            place: this.form.place, 
                            startDate: startObj.toISOString(), 
                            endDate: endObj.toISOString(),
                            purpose: this.form.purpose,
                            students: this.session.$id, 
                            status: 'approved', 
                            wardenApproval: wardenStatus,
                            mentorApproval: mentorStatus,
                            supervisorApproval: supervisorStatus, 
                            numberOfDays: days
                        });
                        
                        this.regenerateQR(doc);
                    } catch (e) { alert(e.message); }
                    this.loading = false;
                },

                async loadHistory() {
                    this.tab = 'history';
                    try {
                        const res = await this.databases.listDocuments(this.dbId, this.collId, [
                            Query.equal('students', this.session.$id),
                            Query.orderDesc('$createdAt'),
                            Query.limit(50)
                        ]);
                        
                        const now = new Date();
                        this.activePasses = [];
                        this.expiredPasses = [];

                        res.documents.forEach(doc => {
                            const end = new Date(doc.endDate);
                            if (end > now) this.activePasses.push(doc);
                            else this.expiredPasses.push(doc);
                        });
                    } catch(e) { console.error(e); }
                },

                regenerateQR(doc) {
                    this.ticket = { id: doc.$id, place: doc.place };
                    this.tab = 'verify';
                    setTimeout(() => {
                        document.getElementById('qrcode').innerHTML = '';
                        new QRCode(document.getElementById('qrcode'), { text: doc.$id, width: 150, height: 150 });
                    }, 200);
                },

                downloadQR() {
                    const img = document.querySelector('#qrcode img');
                    if (img && img.src) {
                        const link = document.createElement('a');
                        link.href = img.src;
                        link.download = `PASS_${this.ticket.place}.png`;
                        link.click();
                    } else {
                        const canvas = document.querySelector('#qrcode canvas');
                        if (canvas) {
                            const link = document.createElement('a');
                            link.href = canvas.toDataURL();
                            link.download = `PASS_${this.ticket.place}.png`;
                            link.click();
                        }
                    }
                },

                startScanner() {
                    const qr = new Html5Qrcode("reader");
                    qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { qr.stop(); this.verify(txt); });
                },
                async handleFileUpload(e) {
                    const qr = new Html5Qrcode("reader");
                    try { const res = await qr.scanFile(e.target.files[0], true); this.verify(res); } catch { this.scanResult = "ERR: NO_DATA"; }
                },
                async verify(id) {
                    try {
                        const doc = await this.databases.getDocument(this.dbId, this.collId, id);
                        this.scanResult = JSON.stringify({ STATUS: doc.status, PLACE: doc.place, TIME: doc.startDate }, null, 2);
                    } catch { this.scanResult = "ERR: INVALID_ID"; }
                }
            }
        }
    </script>
</body>
</html>